<script type="text/javascript">
    const defaultSeries = {show:true, spanGaps:true, forward: false, width: 2, dash: [], stroke:'#ff0000',fill:'#ff00004d',
        points:{show: true, space: 10, width: 1, size: 10}}
    const defaultAxes = {
        show:true, width: 1, label:'unnamed', stroke:'#7f7f7fcc',
        grid: {show:true, stroke:'#7f7f7fcc', width: 1, dash: [1,5]},
        ticks: {show:true, stroke:'#7f7f7fcc', width: 2, dash: [], size: 10}
    };
    const defaults = {
        legendFunction : `function(self, rawValue){\n  \\format your legend sting\n  return (rawValue == null) ? '' : rawValue.toFixed(2);\n}`,
        colors : ['#1F77B4', '#AEC7E8', '#FF7F0E', '#2CA02C', '#98DF8A', '#D62728', '#FF9896', '#9467BD', '#C5B0D5'],
        axesX : {
                    space: 40,
                    incrs: [
                        // minute divisors (# of secs)
                        1,
                        5,
                        10,
                        15,
                        30,
                        // hour divisors
                        60,
                        60 * 5,
                        60 * 10,
                        60 * 15,
                        60 * 30,
                        // day divisors
                        3600,
                    // ...
                    ],
                    // [0]:   minimum num secs in found axis split (tick incr)
                    // [1]:   default tick format
                    // [2-7]: rollover tick formats
                    // [8]:   mode: 0: replace [1] -> [2-7], 1: concat [1] + [2-7]
                    values: [
                    // tick incr          default           year                             month    day                        hour     min                sec       mode
                        [3600 * 24 * 365,   "{YYYY}",         null,                            null,    null,                      null,    null,              null,        1],
                        [3600 * 24 * 28,    "{MMM}",          "\n{YYYY}",                      null,    null,                      null,    null,              null,        1],
                        [3600 * 24,         "{M}/{D}",        "\n{YYYY}",                      null,    null,                      null,    null,              null,        1],
                        [3600,              "{H}",            "\n{M}/{D}/{YY}",                null,    "\n{M}/{D}",               null,    null,              null,        1],
                        [60,                "{H}:{mm}",       "\n{M}/{D}/{YY}",                null,    "\n{M}/{D}",               null,    null,              null,        1],
                        [1,                 ":{ss}",          "\n{M}/{D}/{YY} {H}:{mm}",       null,    "\n{M}/{D} {H}:{mm}",      null,    "\n{H}:{mm}",      null,        1],
                        [0.001,             ":{ss}.{fff}",    "\n{M}/{D}/{YY} {H}:{mm}",       null,    "\n{M}/{D} {H}:{mm}",      null,    "\n{H}:{mm}",      null,        1],
                    ],
                //  splits:
                },
    }

    function RGBtoHEX (rgbaString, returnType = 'HEX') {
        let toHex = function (value) {
            if (value===undefined) return '';
            value=parseInt(value).toString(16);
            return (value.length === 1) ? '0'+value : value;
        }
        let parts = rgbaString.substring(rgbaString.indexOf('(')+1, rgbaString.indexOf(')')).split(',');
        switch (returnType) {
            case 'HEX': return '#'+toHex(parts[0])+toHex(parts[1])+toHex(parts[2]);
            case 'HEX8': return '#'+toHex(parts[0])+toHex(parts[1])+toHex(parts[2])+toHex(parts[3]*255);
            case 'ALPHA1': return parts[3];
            case 'ALPHA255': return parts[3]*255;
            case 'ALPHA100': return parts[3]*100;
        }
    }

    function HEXtoRGB (hexString, alpha, alphaType = 'ALPHA100') {
        if (hexString===undefined && alpha===undefined) return undefined;
        let components = [];

        for (let i = 1; i<hexString.length; i += 2) {
            components.push(Number("0x" + hexString.substr(i,2)));
        }
        if (components.length === 3 && alpha !== undefined) {
            switch (alphaType) {
                case 'ALPHA1': components.push(alpha); break;
                case 'ALPHA100': components.push(alpha/100); break;
                case 'ALPHA255': components.push(alpha/255); break;
            }
        }
        if (components.length < 4) {
            return `rgb(${components[0]},${components[1]},${components[2]})`;
        } else {
            return `rgba(${components[0]},${components[1]},${components[2]},${components[3].toFixed(2)})`;
        }
    }

    function uplotResizeList (tab,id) {
        var height = $("#dialog-form").height();
        var formRows = $(`#dialog-form>div:not(#node-uplot-config-tabs-content)`);
        for (let i=0; i<formRows.size(); i++) {
            height -= $(formRows[i]).outerHeight(true);
        }
        // resize editableList
        let tabRows = $(`#${tab}>div:not(.node-input-${id}-container-row)`);
        for (let i=0; i<tabRows.size(); i++) {
            height -= $(tabRows[i]).outerHeight(true);
        }
        $(`#node-input-${id}-container`).editableList('height',height-10);
    }

    function addValueOrFunction (config,param,value) {
        if (typeof String.prototype.parseFunction != 'function') {
            String.prototype.parseFunction = function () {
                var funcReg = /function *\(([^()]*)\)[ \n\t]*{(.*)}/gmi;
                var match = funcReg.exec(this.replace(/\n/g, ' '));
                if(match) {
                    return new Function(match[1].split(','), match[2]);
                }
                return null;
            };
        }
        var valueFunction;
        if (typeof value === "string" && (valueFunction = value.parseFunction())) {
            config[param]=valueFunction.bind($scope); // to enable this.send() for callback functions.
        }
        else if (config[param]===undefined) {
            config[param]= value;
        }
    }

    function mergeObject (destinationObject,sourceObject) {
        for (var element in sourceObject) {
            if (typeof sourceObject[element] === "object" || Array.isArray(sourceObject[element])) {
                if (!destinationObject[element]) destinationObject[element]=(Array.isArray(sourceObject[element]))? [] : {};
                mergeObject(destinationObject[element],sourceObject[element])
            } else {
                addValueOrFunction(destinationObject,element,sourceObject[element]);
            }
        }
    }
    /**
    *  add item to an array of objects identified by a key
    *   @param  {array} target array of objects
    *   @param  {object} item object to add
    *   @param  {string} key identifier to match existing
    *   @param  {object} (optional) defaultObject if new
    *   @param  {function (item,index)} (optional) callback if default object is added to manipulate individual values
    **/
    function addOrUpdateItem(target, item, key, defaultObject = {}, update) {
        if (!item || !item.hasOwnProperty(key)) return;
        let index = target.findIndex(element => element[key] === item[key])
        
        if (index<0) { 
            index = target.push({})-1;
            mergeObject(target[index], defaultObject);
            if (update!==undefined) update(target[index],index);
        }
        mergeObject(target[index],item);
        return target[index];
    }

    function uplotGetConfig(node,query, params, doneCallback) {
        var config = {'query': query, 'params': params };
        //console.log('uplotGetConfig query', node.id, query);
        $.getJSON("/uPlot/"+node.id, config)
        .done( doneCallback )
        .fail( function(e1, e2, e3) {
            console.error("uplotGetConfig error : " + JSON.stringify(e1));
        });
    }

    RED.nodes.registerType('ui_uplot-charts',{

        category: 'Dashboard',
        color: 'rgb( 63, 173, 181)',

        defaults: {
            group: {type: 'ui_group', required:true},
            order: {value: 0},
            width: {
                value: 0,
                validate: function(v) {
                    var valid = true
                    var width = v||0;
                    var currentGroup = $('#node-input-group').val()|| this.group;
                    var groupNode = RED.nodes.node(currentGroup);
                    valid = !groupNode || +width <= +groupNode.width;
                    $("#node-input-size").toggleClass("input-error",!valid);
                    return valid;
                }},

            height: {value: 0},
            name: {value: ''},
            title: {value: ''},
            series: {value: []},
            scales: {value: []},
            axes: {value: []},
            axesX: {value: {}},
            plugins: {value: []},
            dataPlugins: {value: []},
            dataStore: {value: {}},
            debugServer: {value: false},
            debugClient: {value: false},
            spaceForTitle: {value: 50},
            spaceForLegend: {value: 50},
            seriesFilter: {value: 'series-all'},
            hideFiltered: {value: false}
        },

        inputs:1,
        outputs:1,
        icon: "uPlot.svg",
        paletteLabel:"uplot chart",

        label: function() {
            return this.name || this.label || "uplot-charts";
            // return this.name || (~this.label.indexOf("{{") ? null : this.label) || "uplot-charts";
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },

        oneditprepare: function() {
            var node = this;
            uplotGetConfig(node,'series', undefined, ( (data) => {
                    console.log('uplotGetConfig series', data);
                    data.forEach(item => {
                        addOrUpdateItem(node.series,item,'topic',defaultSeries,
                            (item,index) => {
                                let color = (defaults.colors[index]!==undefined) ? defaults.colors[index] : '#ff0000';
                                item.stroke = HEXtoRGB(color ,100);
                                item.fill = HEXtoRGB(color,0);
                                item.topicReadOnly = true;
                            }
                        );
                    });
                    $("#node-input-series-container").editableList('empty');
                    node.series.forEach(item => {
                        $("#node-input-series-container").editableList('addItem',item);
                    });
                })
            );

            $("#node-input-size").elementSizer({
                width: "#node-input-width",
                height: "#node-input-height",
                group: "#node-input-group"
            });

            node.tabs = RED.tabs.create({
                id: "node-uplot-config-tabs",
                onchange: function(tab) {
                    $("#node-uplot-config-tabs-content").children().hide();
                    $("#" + tab.id).show();
                    switch (tab.id) {
                        case 'uplot-tab-main-1' : uplotResizeList(tab.id,'series'); break;
                        case 'uplot-tab-main-2' : uplotResizeList(tab.id,'axes'); break;
                        case 'uplot-tab-main-3' : uplotResizeList(tab.id,'scales'); break;
                        case 'uplot-tab-main-4' : uplotResizeList(tab.id,'plugins'); break;
                        case 'uplot-tab-main-5' : uplotResizeList(tab.id,'dataPlugins'); break;
                    }
                }
            });
            for (let i = 0; i<6; i++) {
                let tabLabel = this._("uplot.tabs.main."+i);
                node.tabs.addTab({
                    id: "uplot-tab-main-"+i,
                    node: this,
                    label: tabLabel
                });
            }
            const labelWidth = "20%";
            const contentWidth = 78; // %
            var getContrastYIQ = function (color){
                    let r = parseInt(color.substr(1,2),16);
                    let g = parseInt(color.substr(3,2),16);
                    let b = parseInt(color.substr(5,2),16);
                    return Math.floor(((r*299)+(g*587)+(b*114))/1000);
                }

            node.uiListElements = {
                main : new configUiElements(node,"uplot","main"),
                default : new configUiElements(node,"uplot","default"),
                series : new configUiElements(node,"uplot","series"),
                axes : new configUiElements(node,"uplot","axes"),
                scales : new configUiElements(node,"uplot","scales"),
                plugins : new configUiElements(node,"uplot","plugins"),
                dataPlugins : new configUiElements(node,"uplot","dataPlugins"),
            }
            if (!this.series || this.series.length<1 || this.series.findIndex(value => value.topic==='#')<0 ) this.series.unshift({
                topic:"#",show:true, spanGaps:true, forward: false, width: 2, dash: [], 
                defaultStrokes : ['#1F77B4FF', '#AEC7E8FF', '#FF7F0EFF', '#2CA02CFF', '#98DF8AFF', '#D62728FF', '#FF9896FF', '#9467BDFF', '#C5B0D5FF'],
                defaultFills: ['#1F77B41E', '#AEC7E81E', '#FF7F0E1E', '#2CA02C1E', '#98DF8A1E', '#D627281E', '#FF98961E', '#9467BD1E', '#C5B0D51E']
            });
            if (!this.axes || this.axes.length<1 || this.axes.findIndex(value => value.scale==='#')<0 ) this.axes.unshift({
                show:true, width: 1, scale: '#', label:'', 
                stroke:'#7f7f7fcc',
                grid: {show:true, stroke:'#7f7f7fcc', width: 1, dash: [1,5]},
                ticks: {show:true, stroke:'#7f7f7fcc', width: 2, dash: [], size: 10}
            });
            if (!this.scales || this.scales.length<1 || this.scales.findIndex(value => value.id==='#')<0 ) this.scales.unshift({
                id:'#',
                label: '',
                auto: true
            });
            if (!this.plugins) this.plugins=[];
            if (!this.dataPlugins) this.dataPlugins=[];

            let mainContainer = node.uiListElements.main.setRow($('#node-tab-general'));
            mainContainer.setGroup('appearance',true, 'form-row');
                mainContainer.addClassicLabel('title','fa fa-header');
                mainContainer.addInput('title','text',this.title,contentWidth+'%','title');
            mainContainer.closeGroup();
            mainContainer.setGroup('appearance',true, 'form-row');
                mainContainer.addClassicLabel('name','fa fa-i-cursor');
                mainContainer.addInput('name','text',this.name,contentWidth+'%','name');
            mainContainer.closeGroup();
            mainContainer.addElement('hr');
            mainContainer.setGroup('appearance',true, 'form-row');
                mainContainer.addClassicLabel('spaceForTitle','fa fa-arrows-v');
                mainContainer.addInput('spaceForTitle',{type:'number',min:0,max:200},this.spaceForTitle || 50,contentWidth/2+'%','spaceForTitle');
                mainContainer.addClassicLabel('px');
            mainContainer.closeGroup();
            mainContainer.setGroup('appearance',true, 'form-row');
                mainContainer.addClassicLabel('spaceForLegend','fa fa-arrows-v');
                mainContainer.addInput('spaceForLegend',{type:'number',min:0,max:200},this.spaceForLegend || 50,contentWidth/2+'%','spaceForLegend');
                mainContainer.addClassicLabel('px');
            mainContainer.closeGroup();
            mainContainer.setGroup('debug',true, {id:'form-row',label:'debug',collapsible:true, collapsed:true});
                mainContainer.addClassicLabel('title','fa fa-bug');
                mainContainer.addInput('debugServer',{type:'checkbox',checked: (this.debugServer!==undefined) ? this.debugServer : false},undefined,'5%','debugServer')
                mainContainer.addClassicLabel('debugServer');
                mainContainer.addInput('debugClient',{type:'checkbox',checked: (this.debugClient!==undefined) ? this.debugClient : false},undefined,'5%','debugClient')
                mainContainer.addClassicLabel('debugClient');
            mainContainer.closeGroup();

            // check event to enable/disable a input row
            var checkboxChangeEvent = function (element) {
                let nextElement=element.next();
                let disabled = !element.prop('checked');
                while (nextElement.length>0 && !nextElement.is('br')) {
                    if (nextElement.is('input')) {
                        if (nextElement.hasClass('red-ui-typedInput') && nextElement.typedInput) {
                            nextElement.typedInput(disabled ? 'disable' : 'enable')
                        } else {
                            nextElement.prop('disabled',disabled);
                        }
                    }
                    nextElement = nextElement.next();
                }
            }

            // Series Tab
            var filterOptions = ['series-all','series-label','series-stroke','series-points','series-fill','series-options']
                .map((value,index) => { return {label:node._("uplot.default.select.singleFilters."+index),value}});
            let interpolationOptions = ["linear", "points", "spline", "stepBefore", "stepAfter", "bars"]
                .map(value => { return {i18n:'path',value}});

            let seriesContainer = node.uiListElements.default.setRow($('#node-input-series-top'));
            seriesContainer.setGroup('series-main',true, 'form-row');
                seriesContainer.addClassicLabel('seriesFilter','fa fa-filter');
                seriesContainer.addTypedInput('applyTo',[
                    {
                        value: "singleFilter",
                        label:  node._("uplot.default.label.singleFilter"), 
                        title:  node._("uplot.default.label.singleFilter"), 
                        icon: "fa fa-bars",
                        showLabel: false,
                        multiple: false,
                        options: filterOptions                        
                    },{
                        value: "multiFilter",
                        label:  node._("uplot.default.label.multiFilter"), 
                        title:  node._("uplot.default.label.multiFilter"), 
                        icon: "fa fa-list-ul",
                        showLabel: false,
                        multiple: true,
                        options: filterOptions                        
                    }],
                    this.seriesFilter || 'series-all',
                    (this.seriesFilterType) ? this.seriesFilterType : 'showAll',
                    contentWidth/2+'%',
                    (event, type, value = "series-all") => {
                        if (value === '') value = 'series-all';
                        let element = $(event.target);
                        let lastSelected = element.prop('_lastSelectedValue');
                        console.log('changeSeriesFilter', {event, type, value, lastSelected});
                        let switchState = function (option,state) {
                            let container = $('#node-input-series-container').find(`.${option}`);
                            let icons = $(container.prev())
                            icons.each((index,element) => {
                                $(element).css('display','block');
                                const icons = ["fa fa-plus-square", "fa fa-minus-square"];
                                $(element.firstChild).removeClass(icons[(state) ? 0 : 1]);
                                $(element.firstChild).addClass(icons[(state) ? 1 : 0]);
                            })
                            container.css('display',state ? '' : 'none');
                        }
                        filterOptions.forEach(option => {
                            var state = value.includes(option.value) || value.includes('series-all');
                            switchState(option.value,state);
                        });
                        changeHideFiltered($('.node-input-default-hideFiltered'));
                    }
                );
                seriesContainer.addInput('hideFiltered',{type:'checkbox',checked: (this.hideFiltered!==undefined) ?  this.hideFiltered : false},undefined,'5%')
                var changeHideFiltered = function (event) {
                    let hide = event.prop('checked');
                    filterOptions.forEach(option => {
                        let container = $('#node-input-series-container').find(`.${option.value}`);
                        if (hide) {
                            if (container.css('display')==='none') {
                                console.log(container.prev().css('display'));
                                container.prev().css('display', hide ? 'none' : 'block');
                            }
                        } else {
                            container.prev().css('display', 'block');   
                        }
                    });
                };
                seriesContainer.addEvent('change',changeHideFiltered,'hideFiltered',true);
                seriesContainer.addText('hideFiltered',contentWidth/2-10+'%');
            seriesContainer.closeGroup();

            $('#node-input-series-container')
            .css('min-height','250px').css('min-width','400px')
            .editableList({
                sortable: true,
                removable: true,
                addButton: true,
                addItem: function(row, index, data) {
                    if (!data) data={};

                    // get latest scales
                    let tempScales = [];
                    let scaleIds = [];
                    try {
                        node.uiListElements.scales.save(tempScales,true,["id"]);
                    } catch (err) {
                        tempScales = node.scales;
                    }
                    scaleIds = tempScales.map(item => item.id);

                    var uiElements = node.uiListElements.series.setRow(row);

                    if (data.topic!=='#') {
                        uiElements.addLabel('topic');
                        uiElements.addInput('topic','text',data.topic || '',contentWidth+'%');
                        uiElements.addProp('topic','disabled',data.topicReadOnly);
                        uiElements.setGroup('series-label',true,{id:'series-label',label:'label',collapsible:true});
                            uiElements.addLabel('label');
                            uiElements.addInput('label','text',data.label,contentWidth/2-10+'%');
                            uiElements.addText('&nbsp;','5%');
                            uiElements.addLabel('scale',contentWidth/4-5+'%');
                            uiElements.addSelect('scale',scaleIds,data.scale,contentWidth/4+5+'%');                    
                            uiElements.addElement('br');
                            uiElements.addLabel('legend');
                            uiElements.addTypedInput('legend',
                                [{value:"default", label:"Default", icon:"fa fa-times",hasValue:false},
                                 {value:"function",label:"Function",icon:"fa fa-code",
                                    customValue: (data.legendType === 'function') ? (data.legend || defaults.legendFunction) : defaults.legendFunction},
                                ],
                                data.legend || "default",
                                data.legendType || "default",(contentWidth)+'%'
                            );
                            uiElements.addElement('br');
                        uiElements.closeGroup();
                        uiElements.setGroup('series-stroke',true,{id:'series-stroke',label:'stroke',collapsible:true});
                            uiElements.addLabel('line');
                            uiElements.addInput('stroke','color',data.stroke || defaultSeries.stroke,contentWidth+'%');
                            /*
                            uiElements.addTypedInput('stroke',
                                [{value:"colorRGBA",label:"Colour RGBA", icon:"fa fa-tint", customValue: data.stroke || defaultSeries.stroke}],
                                data.stroke || defaultSeries.stroke, "colorRGBA", (contentWidth)+'%',null,{hideTypeSelect: true, hideBorder: true}
                            );
                            */
                            uiElements.addElement('br');
                            uiElements.addText('&nbsp;');
                            uiElements.addLabel('width',contentWidth/4-5+'%');
                            uiElements.addInput('width',{type:'number',min:0,max:100},data.width || defaultSeries.width,contentWidth/4-5+'%')
                            uiElements.addText('px','5%');
                            uiElements.addLabel('dash',contentWidth/4-5+'%');
                            let dash = (data.dash!==undefined) ? JSON.stringify(data.dash) : JSON.stringify(defaultSeries.dash);
                            uiElements.addTypedInput('dash',["json"],dash,'json',contentWidth/4+5+'%');
                            uiElements.addElement('br');
                            uiElements.addLabel('path');
                            uiElements.addSelect('path',interpolationOptions,data.path,contentWidth+'%');
                        uiElements.closeGroup();
                    } else {
                        row.parent().prop('id','seriesDefault'); // mark this row as default to hide the sort and delete controls later
                        uiElements.setGroup('defaultSeries',true,{id:'defaultSeries',label:'defaultSeries',collapsible:true, collapsed: true, textStyle: 'font-weight: bold;'});
                            uiElements.addInput('topic','text',data.topic || '',contentWidth+'%','',false); // hidden input for topic
                            uiElements.setGroup('series-stroke',true,{id:'series-stroke',label:'stroke',collapsible:true});
                                uiElements.addLabel('colors');
                                uiElements.addTypedInput('defaultStrokes',["json"],JSON.stringify(data.defaultStrokes || defaults.colors),'json',contentWidth-5+'%');
                                uiElements.addElement('br');
                                uiElements.addText('&nbsp;');
                                uiElements.addLabel('width',contentWidth/4-5+'%');
                                uiElements.addInput('width',{type:'number',min:0,max:100},data.width || defaultSeries.width,contentWidth/4-5+'%')
                                uiElements.addText('px','5%');
                                uiElements.addLabel('dash',contentWidth/4-5+'%');
                                let dash = (data.dash!==undefined) ? JSON.stringify(data.dash) : JSON.stringify(defaultSeries.dash);
                                uiElements.addTypedInput('dash',["json"],dash,'json',contentWidth/4+5+'%');
                                uiElements.addElement('br');
                                uiElements.addLabel('path');
                                uiElements.addSelect('path',interpolationOptions,data.path,contentWidth+'%');
                            uiElements.closeGroup();
                    }

                    //points
                    uiElements.setGroup('series-points',false,{id:'series-points',label:'points',collapsible:true});
                        if (data.topic!=='#') {
                            uiElements.addLabel('visibility');
                            uiElements.addTypedInput('points.show',
                                [{value:"default", label:"default", icon:"fa fa-times",hasValue:false},
                                {value:"show", label:"show", icon:"fa fa-check-square-o",hasValue:false},
                                {value:"hide", label:"hide", icon:"fa fa-square-o",hasValue:false},
                                {value:"multiValue", label:"space", icon:"fa fa-arrows-h", inputs:[
                                    {property:'space',props:{type:'number',min:0,max:100},value: data.points?.space || defaultSeries.points.space},
                                ]},
                                {value:"function",label:"Function",icon:"fa fa-code",
                                    customValue: data.legend || `(self, seriesIdx, idx0, idx1) => {\n  return true;\n}`}],
                                data.points?.show || "default", data.points?.showType || "default", (contentWidth)+'%'
                            );
                            uiElements.addElement('br');

                            uiElements.addLabel('dimensions');
                            uiElements.addTypedInput('points.dimensions',
                                [{value:"default", label:"Default", icon:"fa fa-times",hasValue:false},
                                {value:"multiValue",label:"Dimensions", icon:"fa fa-expand",
                                inputs:[
                                    {property:'size',props:{type:'number',min:0,max:100},value: data.points?.dimensions?.size || defaultSeries.points.size},
                                    {property:'width',props:{type:'number',min:0,max:100},value: data.points?.dimensions?.width || defaultSeries.points.width},
                                ],
                                customValue: data.points|| defaultSeries.points}],
                                data.points?.dimensions || "default", data.points?.dimensionsType || "default",(contentWidth)+'%'
                            );
                            console.log(data.points?.dimensionsType);
                            uiElements.addElement('br');

                            uiElements.addLabel('stroke');
                            uiElements.addTypedInput('points.strokeColor',
                                [{value:"default", label:"Default", icon:"fa fa-times",hasValue:false},
                                {value:"colorRGBA",label:"Colour RGBA", icon:"fa fa-eyedropper", customValue: data.points?.strokeColor || defaultSeries.stroke, linkValue: ['colorPalette']},
                                {value:"colorPalette",label:"Color Palette",icon:"fa fa-tint", customValue: data.points?.strokeColor || defaultSeries.stroke, linkValue: ['colorRGBA']}],
                                data.points?.strokeColor || "default", data.points?.strokeColorType || "default",(contentWidth)+'%'
                            );
                            uiElements.addElement('br');
                            uiElements.addLabel('fill');
                            uiElements.addTypedInput('points.fillColor',
                                [{value:"default", label:"Default", icon:"fa fa-times",hasValue:false},
                                {value:"colorRGBA",label:"Colour RGBA", icon:"fa fa-eyedropper", customValue: data.points?.fillColor || defaultSeries.fill, linkValue: ['colorPalette']},
                                {value:"colorPalette",label:"Color Palette",icon:"fa fa-tint", customValue: data.points?.fillColor || defaultSeries.fill, linkValue: ['colorRGBA']}],
                                data.points?.fillColor || "default", data.points?.fillColorType || "default",(contentWidth)+'%'
                            );
                        } else {
                            uiElements.addLabel('stroke');
                            uiElements.addTypedInput('points.strokeColor',
                                [{value:"default", label:"Default", icon:"fa fa-times",hasValue:false},"json"],
                                JSON.stringify(data.points?.defaultStrokes || defaults.colors), data.points?.defaultStrokesType || "default",(contentWidth)+'%'
                            );
                            uiElements.addElement('br');
                            uiElements.addLabel('fill');
                            uiElements.addTypedInput('points.fillColor',
                                [{value:"default", label:"Default", icon:"fa fa-times",hasValue:false},"json"],
                                JSON.stringify(data.points?.defaultFills || defaults.colors), data.points?.defaultFillsType || "default",(contentWidth)+'%'
                            );
                        }
                        uiElements.addElement('br');
                    uiElements.closeGroup();
                    //fillColor
                    uiElements.setGroup('series-fill',true,{id:'series-fill',label:'fill',collapsible:true});
                        if (data.topic!=='#') {
                            uiElements.addLabel('fill');
                            uiElements.addInput('fill','color',data.fill || defaultSeries.fill,contentWidth+'%');
                        } else {
                            uiElements.addLabel('colors');
                            uiElements.addTypedInput('defaultFills',["json"],JSON.stringify(data.defaultFills || defaults.colors),'json',contentWidth-5+'%');
                        }
                        uiElements.addElement('br');
                    uiElements.closeGroup();
                    
                    //Options
                    uiElements.setGroup('series-options',true,{id:'series-options',label:'options',collapsible:true});
                        uiElements.addLabel('&nbsp;');
                        uiElements.addInput('spanGaps',{type:'checkbox',checked: (data.spanGaps!==undefined) ? data.spanGaps : defaultSeries.spanGaps},undefined,'5%')
                        uiElements.addText('spanGaps',contentWidth/3-5+'%');
                        uiElements.addInput('show',{type:'checkbox',checked: (data.show!==undefined) ? data.show : defaultSeries.show},undefined,'5%')
                        uiElements.addText('show',contentWidth/3-5+'%');
                        uiElements.addInput('forward',{type:'checkbox',checked: (data.forward!==undefined) ? data.forward : defaultSeries.forward},undefined,'5%')
                        uiElements.addText('forward',contentWidth/3-5+'%');
                    uiElements.closeGroup();

                    if (data.topic==='#') {
                        uiElements.closeGroup();
                    }
                }
            });
            $("#node-input-series-container").editableList('addItems', this.series);
            setTimeout(() => {
                $('#seriesDefault').find(".red-ui-editableList-item-handle").css("display","none");
                $('#seriesDefault').find(".red-ui-editableList-item-remove").css("display","none");
                //changeSeriesFilter(undefined, node.seriesFilter || 'series-all');
            },500);

            let axesContainer = node.uiListElements.default.setRow($('#node-input-axes-top'));
            axesContainer.setGroup('axes-main',true, 'form-row');
                axesContainer.addClassicLabel('xaxes','fa fa-clock-o');
                if (!this.axesX) this.axesX = defaults.axesX;
                axesContainer.addButton('24h','24h','10%','click',(button => {
                        axesContainer.setInput('24h','<i class="fa fa-spinner fa-spin">');
                        uplotGetConfig(node,'axesX','24h',(data => {
                            axesContainer.setInput('axesX',JSON.stringify(data));
                            axesContainer.setInput('24h','24h');
                        }));
                    })
                );
                axesContainer.addButton('12h','12h','10%','click',(button => {
                        axesContainer.setInput('12h','<i class="fa fa-spinner fa-spin">');
                        uplotGetConfig(node,'axesX','12h',(data => {
                            axesContainer.setInput('axesX',JSON.stringify(data));
                            axesContainer.setInput('12h','12h');
                        }));
                    })
                );
                axesContainer.addTypedInput('axesX',["json"],JSON.stringify(this.axesX),'json',(contentWidth-25)+'%');
            axesContainer.closeGroup();


            $('#node-input-axes-container')
            .css('min-height','250px').css('min-width','400px')
            .editableList({
                sortable: true,
                removable: true,
                addButton: true,
                addItem: function(row, index, data) {
                    if (!data) data={};
                    if (!data.grid) data.grid={};
                    if (!data.ticks) data.ticks={};

                    let tempScales = [];
                    let scaleIds = [];
                    try {
                        node.uiListElements.scales.save(tempScales);
                    } catch (err) {
                        tempScales = node.scales;
                    }
                    scaleIds = tempScales.map(item => item.id);

                    var uiElements = node.uiListElements.axes.setRow(row);

                    if (data.scale!=='#') {
                        uiElements.addLabel('label');
                        uiElements.addInput('label','text',data.label,contentWidth/2-10+'%');
                        uiElements.addText('&nbsp;','5%');
                        uiElements.addLabel('scale',contentWidth/4-5+'%');
                        uiElements.addSelect('scale',scaleIds,data.scale,contentWidth/4+5+'%');
                        uiElements.addElement('br');
                        //side
                        let side = [0,1,2,3,4].map(value =>{return {i18n:'side',value}});
                        uiElements.addLabel('side');
                        uiElements.addSelect('side',side,data.side,contentWidth/2+'%','integer');
                        uiElements.setProp('scale','disabled',data.side===4);
                        uiElements.addEvent('change',(function (element) {
                            var uiElement = uiElements;
                            if (parseInt(element.val())===4) {
                                uiElement.setProp('scale','disabled',true);
                            }
                        }))
                    } else {
                        row.parent().prop('id','axisDefault');
                        uiElements.addInput('scale','text','#',contentWidth+'%','',false);
                        uiElements.addLabel('defaultAxes','100%');
                        uiElements.addElement('br');
                        uiElements.addLabel('label');
                        uiElements.addInput('label','text',data.label,contentWidth+'%');
                        uiElements.addElement('br');
                        //side
                        let side = [0,1].map(value =>{return {i18n:'side',value}});
                        uiElements.addLabel('side');
                        uiElements.addSelect('side',side,data.side,contentWidth/2+'%','integer');
                    }

                    uiElements.addElement('br');

                    uiElements.addLabel('label');
                    uiElements.addInput('stroke','color',data.stroke || defaultAxes.stroke,contentWidth+'%');
                    uiElements.addElement('br');
                    
                    // grid
                    uiElements.addLabel('grid');
                    uiElements.addInput('grid.stroke','color',data.grid.stroke || defaultAxes.grid.stroke,contentWidth+'%');

                    uiElements.addText('&nbsp;');
                    uiElements.addLabel('width',contentWidth/4-5+'%');
                    uiElements.addInput('grid.width',{type:'number',min:0,max:100},data.grid.width || defaultAxes.grid.width,contentWidth/4-5+'%')
                    uiElements.addText('px','5%');
                    uiElements.addLabel('dash',contentWidth/4-5+'%');
                    let gridDash = (data.grid.dash!==undefined) ? JSON.stringify(data.grid.dash) : JSON.stringify(defaultAxes.grid.dash);
                    uiElements.addTypedInput('grid.dash',["json"],gridDash,'json',contentWidth/4+5+'%');
                    uiElements.addElement('br');
                    
                    uiElements.addText('&nbsp;');
                    uiElements.addInput('grid.show',{type:'checkbox',checked: (data.grid.show!==undefined) ? data.grid.show : defaultAxes.grid.show},undefined,'5%')
                    uiElements.addText('show',contentWidth/3-5+'%');
                    uiElements.addElement('br');
                    // ticks
                    uiElements.addLabel('ticks');
                    uiElements.addInput('ticks.stroke','color',data.ticks.stroke || defaultAxes.ticks.stroke,contentWidth+'%');
                    uiElements.addElement('br');

                    uiElements.addText('&nbsp;');
                    uiElements.addLabel('width',contentWidth/4-5+'%');
                    uiElements.addInput('ticks.width',{type:'number',min:0,max:100},data.ticks.width || defaultAxes.ticks.width,contentWidth/4-5+'%')
                    uiElements.addText('px','5%');
                    uiElements.addLabel('dash',contentWidth/4-5+'%');
                    let ticksDash = (data.ticks.dash!==undefined) ? JSON.stringify(data.ticks.dash) : JSON.stringify(defaultAxes.ticks.dash);
                    uiElements.addTypedInput('ticks.dash',["json"],ticksDash,'json',contentWidth/4+5+'%');
                    uiElements.addElement('br');

                    uiElements.addText('&nbsp;');
                    uiElements.addInput('ticks.show',{type:'checkbox',checked: (data.ticks.show!==undefined) ? data.ticks.show : defaultAxes.ticks.show},undefined,'5%')
                    uiElements.addText('show',contentWidth/3-5+'%');
                }
            });
            $("#node-input-axes-container").editableList('addItems', this.axes);
            $('#axisDefault').find(".red-ui-editableList-item-handle").css("display","none");
            $('#axisDefault').find(".red-ui-editableList-item-remove").css("display","none");

            $('#node-input-scales-container')
            .css('min-height','250px').css('min-width','400px')
            .editableList({
                sortable: true,
                removable: true,
                addButton: true,
                addItem: function(row, index, data) {
                    if (!data) data={};
                    var uiElements = node.uiListElements.scales.setRow(row);
                    if (data.id!=='#') {
                        uiElements.addLabel('id');
                        uiElements.addInput('id','text',data.id || '', contentWidth+'%');
                        uiElements.addElement('br');
                    } else {
                        row.parent().prop('id','scaleDefault');
                        uiElements.addInput('id','text',data.id || '', contentWidth+'%', '', false);
                        uiElements.addLabel('defaultScale','100%');
                        uiElements.addElement('br');

                    }
                    uiElements.addLabel('name');
                    uiElements.addInput('name','text', data.name || '', contentWidth+'%');
                    uiElements.addElement('br');

                    uiElements.addLabel('range');
                    uiElements.addInput('auto',{type:'checkbox',checked: (data.auto!==undefined) ? data.auto : true},undefined,'5%')
                    uiElements.addText('auto','15%');
                    uiElements.addLabel('min',contentWidth/4-10+'%');
                    uiElements.addInput('min',{type:'number'},data.min || 0,contentWidth/4+'%'),
                    uiElements.addLabel('max',contentWidth/4-10+'%');
                    uiElements.addInput('max',{type:'number'},data.max || 100,contentWidth/4+'%'),
                    uiElements.addElement('br');

                }
            });
            $("#node-input-scales-container").editableList('addItems', this.scales);
            $('#scaleDefault').find(".red-ui-editableList-item-handle").css("display","none");
            $('#scaleDefault').find(".red-ui-editableList-item-remove").css("display","none");

            //console.log(RED.settings.context.stores);

            if (!this.dataStore || !RED.settings.context.stores.includes(this.dataStore.store)) {
                this.dataStore.store = RED.settings.context.default;
            }
            let dataStores = RED.settings.context.stores || ["default"];
            let dataContainer = node.uiListElements.default.setRow($('#node-input-data-top'));
        
            dataContainer.setGroup('data-main',true, 'form-row');
                dataContainer.addClassicLabel('store','fa fa-database');
                dataContainer.addTypedInput(
                    'dataStore',
                    [{value:"store",label:"node",options:dataStores},"flow","global"],
                    (this.dataStore.typedValue) ? this.dataStore.typedValue : this.dataStore.store,
                    this.dataStore.context,(contentWidth-40)+'%'
                );
                    /*,
                    (event, type, value) => {
                        let element = $(event.target);
                        let lastSelected = element.prop('_lastSelectedValue');
                        let lastSelectedType = element.prop('_lastSelectedType');
                        console.log('change event', {event, type, value, lastSelected, lastSelectedType})
                        switch (type) {
                            case 'global':
                            case 'flow': 
                                if (lastSelected && value!==lastSelected) { 
                                    element.typedInput('value', lastSelected);
                                }
                                element.prop('_lastSelectedValue',value);
                                break;
                        }
                        element.prop('_lastSelectedType',type);
                    }
                );*/
                dataContainer.addButton('erase','erase','15%','click',(button => {
                    dataContainer.setInput('erase','<i class="fa fa-spinner fa-spin">');
                    var myNotification = RED.notify(node._("uplot.dialogs.erase.text"),{
                        modal: true,
                        fixed: true,
                        type: 'warning', // can be null, 'compact', 'success', 'warning', 'error'
                        buttons: [
                            {
                                text: node._("uplot.dialogs.erase.button.0"),
                                click: function(e) {
                                    myNotification.close();
                                    dataContainer.setInput('erase','erase');
                                }
                            },
                            {
                                text: node._("uplot.dialogs.erase.button.1"),
                                class:"primary",
                                click: function(e) {
                                    myNotification.close();
                                    uplotGetConfig(node,'eraseData','all',(data => {
                                        if (data==='ok') {
                                            dataContainer.setInput('erase','erase');
                                        } else {
                                            dataContainer.setInput('erase',data);
                                        }
                                    }));
                                }
                            }
                        ]
                    });
                }));
                dataContainer.addButton('info','info','10%','click',(button => {
                    uplotGetConfig(node,'getSizes','',(data => {
                        var myNotification = RED.notify(node._("uplot.dialogs.info.text")+"<br><pre>"+JSON.stringify(data, null, 2)+"</pre>",{
                            modal: true,
                            fixed: true,
                            type: null, // can be null, 'compact', 'success', 'warning', 'error'
                            buttons: [
                                {
                                    text: node._("uplot.dialogs.info.button.0"),
                                    click: function(e) {
                                        myNotification.close();
                                    }
                                }
                            ]
                        });
                    }));
                }));
                dataContainer.addButton('clean','clean','10%','click',(button => {
                    uplotGetConfig(node,'clean','',(data => {
                        var myNotification = RED.notify(node._("uplot.dialogs.clean.text")+"<br><hr>"+data+"<hr>",{
                            modal: true,
                            fixed: true,
                            type: null, // can be null, 'compact', 'success', 'warning', 'error'
                            buttons: [
                                {
                                    text: node._("uplot.dialogs.clean.button.0"),
                                    click: function(e) {
                                        myNotification.close();
                                    }
                                }
                            ]
                        });
                    }));
                }));
            dataContainer.closeGroup();

            $('#node-input-dataPlugins-container')
            .css('min-height','250px').css('min-width','400px')
            .editableList({
                sortable: true,
                removable: true,
                addButton: true,
                addItem: function(row, index, data) {
                    if (!data) data={};
                    var uiElements = node.uiListElements.dataPlugins.setRow(row);

                    // plugin dropdown
                    const maxDataPlugins = 5;
                    const dataPlugins = ['none','limitTime','limitColumns','reduceData','timePrecision','cleanTable']
                    let options = dataPlugins.map(value => {return {i18n:'plugins',value}});
                    uiElements.addClassicLabel('plugin','fa fa-plug');
                    let pluginElement = uiElements.addSelect('plugin',options,data.plugin || 'none',contentWidth-20+'%');
                    uiElements.addEvent('change',(function (element) {
                        uiElements.setGroupVisibility(element,'plugins',element.val());
                    }))
                    uiElements.addInput('enabled',{type:'checkbox',checked: (data.enabled!==undefined) ? data.enabled : true},undefined,'5%');
                    uiElements.addText('enabled','15%');
                    
                    let timePeriods =[]; // seconds ... weeks
                    for (let i = 0; i < 5; i++) { timePeriods.push({i18n:'period',value: node._("uplot.dataPlugins.select.periods."+i)}) };
                    let timePeriodsClean =[{text:node._("uplot.dataPlugins.label.messages"), value: 0}]; // messages,seconds,minutes ... month
                    for (let i = 0; i < 6; i++) { timePeriodsClean.push({text:node._("uplot.dataPlugins.select.period."+i), value: node._("uplot.dataPlugins.select.periods."+i)}) };
                    let timePeriodsMonth =[]; // seconds ... month
                    for (let i = 0; i < 6; i++) { timePeriodsMonth.push({i18n:'period',value: node._("uplot.dataPlugins.select.periods."+i)}) };
                    let timePeriodsYears =[]; // seconds ... years
                    for (let i = 0; i < 7; i++) { timePeriodsYears.push({i18n:'period',value: node._("uplot.dataPlugins.select.periods."+i)}) };

                    // get rows
                    let tempSeries = [];
                    try {
                        node.uiListElements.series.save(tempSeries,true,["topic","label"]);
                    } catch (err) {
                        tempSeries = node.series;
                    }
                    let seriesSelect = tempSeries.map(item => { return {value:item.topic, label:item.label, title:item.topic, multiple:true}});
                    // seriesSelect.unshift({value:"", label:node._("uplot.dataPlugins.label.reduceData.allSeries"), title:node._("uplot.dataPlugins.label.reduceData.allSeries"), multiple:false});

                    uiElements.setGroup('plugins',true); // options container
                        // limit time
                        uiElements.setGroup('limitTime',false);
                            uiElements.addLabel('limit');
                            uiElements.addLabel('last',contentWidth/4-5+'%');
                            uiElements.addInput('last',{type:'number',min:1},data.last || 1,contentWidth/4+5+'%');
                            uiElements.addSelect('period',timePeriodsYears,data.period || 3600,contentWidth/2+'%','integer');
                            uiElements.addElement('br');
                            
                            uiElements.addLabel('every');
                            uiElements.addInput('limitTimeEvery',{type:'number',min:1},data.limitTimeEvery || 1,contentWidth/2+'%');
                            uiElements.addSelect('limitTimePeriods',timePeriodsClean,data.limitTimePeriods || 3600,contentWidth/2+'%','integer');
                            uiElements.addElement('br');
                            uiElements.addLabel('client');
                            uiElements.addLabel('check',contentWidth/2+'%');
                            uiElements.addInput('checkEvery',{type:'number',min:0},data.checkEvery || 0,contentWidth/2-10+'%');
                            uiElements.addLabel('seconds',"10%");                        
                        uiElements.closeGroup();
                        // limit columns
                        uiElements.setGroup('limitColumns',false);
                            uiElements.addLabel('columns');
                            uiElements.addInput('columns',{type:'number',min:1},data.columns || 10000,contentWidth+'%'),
                            uiElements.addElement('br');

                            uiElements.addLabel('every');
                            uiElements.addInput('limitColumnsEvery',{type:'number',min:1},data.limitColumnsEvery || 1,contentWidth/2+'%');
                            uiElements.addSelect('limitColumnsPeriods',timePeriodsClean,(data.limitColumnsPeriods!==undefined) ? data.limitColumnsPeriods : 3600,contentWidth/2+'%','integer');                            
                            uiElements.addElement('br');
                            
                            uiElements.addLabel('client');
                            uiElements.addLabel('check',contentWidth/2+'%');
                            uiElements.addInput('checkEvery',{type:'number',min:0},data.checkEvery || 0,contentWidth/2-10+'%');
                            uiElements.addLabel('seconds',"10%");

                        uiElements.closeGroup();
                        // precision
                        uiElements.setGroup('timePrecision',false);
                            uiElements.addLabel('precision');
                            uiElements.addInput('timePrecision',{type:'number',min:1},data.timePrecision || 1,contentWidth/2+'%'),
                            uiElements.addLabel('milliseconds',contentWidth/2+'%');
                        uiElements.closeGroup();
                        // reduce data
                        uiElements.setGroup('reduceData',false);
                            uiElements.addLabel('older');
                            uiElements.addInput('older',{type:'number',min:1},data.older || 1,contentWidth/2+'%');
                            uiElements.addSelect('threshold',timePeriodsYears,data.threshold || 86400,contentWidth/2+'%','integer');
                            uiElements.addElement('br');
                            uiElements.addLabel('period');
                            uiElements.addInput('span',{type:'number',min:1},data.span || 1,contentWidth/2+'%');
                            uiElements.addSelect('periods',timePeriodsMonth,data.periods || 60,contentWidth/2+'%','integer');
                            uiElements.addElement('br');
                            uiElements.addLabel('applyTo');
                            // uiElements.addSelect('applyTo',seriesSelect,data.apply || "",contentWidth+'%','array',{multiple : true, size : 3});
                            
                            if (data.applyTo === undefined) data.applyTo="";
                            uiElements.addTypedInput('applyTo',[{
                                value: "allSeries",
                                label: node._("uplot.dataPlugins.label.reduceData.allSeries"),
                                title: node._("uplot.dataPlugins.label.reduceData.allSeries"),
                                icon: "fa fa-bars",
                                hasValue: false
                            },{
                                value: "selected",
                                label:  node._("uplot.dataPlugins.label.reduceData.selectedSeries"), 
                                title:  node._("uplot.dataPlugins.label.reduceData.selectedSeries"), 
                                icon: "fa fa-list-ul",
                                showLabel: false,
                                multiple: true,
                                options: seriesSelect                        
                            }],
                                data.applyTo,
                                (data.applyTo === '') ? 'allSeries' : 'selected',
                                contentWidth-2+'%',
                                (event, type, value) => {
                                    let element = $(event.target);
                                    let lastSelected = element.prop('_lastSelectedValue');
                                    // console.log('change event', {event, type, value, lastSelected})
                                    switch (type) {
                                        case 'selected': 
                                            if (lastSelected && value!==lastSelected) { 
                                                element.typedInput('value', lastSelected);
                                            }
                                            element.prop('_lastSelectedValue',value);
                                            break;
                                    }
                                }
                            );
    
                            uiElements.addElement('br');

                            let methods =[];
                            for (let i = 0; i < 4; i++) { 
                                methods.push({i18n:'methods'})
                            };
                            uiElements.addLabel('method');
                            uiElements.addSelect('method',methods,data.method || 0,contentWidth+'%');
                            uiElements.addElement('br');

                            uiElements.addLabel('resultAt');
                            let resultsAt =[]; 
                            for (let i = 0; i < 4; i++) { resultsAt.push({i18n:'resultsAt',value: i}) };
                            uiElements.addSelect('resultAt',resultsAt,(data.resultAt!==undefined)? data.resultAt : 2,contentWidth+'%','integer');

                        uiElements.closeGroup();
                        // cleanTable
                        uiElements.setGroup('cleanTable',false);
                            uiElements.addLabel('clean');
                            uiElements.addLabel('every',contentWidth/4-5+'%');
                            uiElements.addInput('cleanEvery',{type:'number',min:1},data.cleanEvery || 1,contentWidth/4+5+'%');
                            uiElements.addSelect('cleanPeriod',timePeriodsClean,data.cleanPeriod || 3600,contentWidth/2+'%','integer');
                        uiElements.closeGroup();
                    uiElements.closeGroup();
                    
                    uiElements.setGroupVisibility(pluginElement,'plugins',data.plugin || 'none');
                }
            });
            $("#node-input-dataPlugins-container").editableList('addItems', this.dataPlugins);

            $('#node-input-plugins-container')
            .css('min-height','250px').css('min-width','400px')
            .editableList({
                sortable: true,
                removable: true,
                addButton: true,
                addItem: function(row, index, data) {
                    if (!data) data={};
                    var uiElements = node.uiListElements.plugins.setRow(row);

                    // plugin dropdown
                    const plugins = ['none','bands','keepZoomLevelPlugin','wheelPanZoomPlugin','touchZoomPlugin','columnHighlightPlugin','legendAsTooltipPlugin']
                    let options = plugins.map(value => { return {i18n:'plugins',value}})

                    let defaultZoomPeriods =[]; // seconds ... years
                    for (let i = 0; i < 7; i++) { defaultZoomPeriods.push({i18n:'period',value: node._("uplot.plugins.select.periods."+i)}) };

                    uiElements.addClassicLabel('plugin','fa fa-plug');
                    let pluginElement = uiElements.addSelect('plugin',options,data.plugin || 'none',contentWidth-20+'%');
                    uiElements.addEvent('change',(function (element) {
                        uiElements.setGroupVisibility(element,'plugins',element.val());
                    }))
                    uiElements.addInput('enabled',{type:'checkbox',checked: (data.enabled!==undefined) ? data.enabled : true},undefined,'5%');
                    uiElements.addText('enabled','15%');

                    uiElements.setGroup('plugins',true); // options container
                        // bands plugin
                        uiElements.setGroup('bands',false);
                            let topics =[];
                            node.series.forEach(item => { topics.push(item.topic) });
                            uiElements.addLabel('low');
                            uiElements.addSelect('from',topics,data.from,contentWidth+'%');
                            uiElements.addElement('br');
                            
                            uiElements.addLabel('high');
                            uiElements.addSelect('to',topics,data.to,contentWidth+'%');
                            uiElements.addElement('br');

                            uiElements.addLabel('band');
                            uiElements.addInput('fill','color',data.fill || defaultSeries.fill,contentWidth+'%');
                        uiElements.closeGroup();
                        // keep zoom level
                        uiElements.setGroup('keepZoomLevelPlugin',false);
                            uiElements.addText('&nbsp;');
                            uiElements.addInput('panWithData',{type:'checkbox',checked: (data.panWithData!==undefined) ? data.panWithData : true},undefined,'5%');
                            uiElements.addText('panWithData',contentWidth-5+'%');
                            uiElements.addElement('br');
                            uiElements.addLabel('defaultX');
                            uiElements.addLabel('defaultZoom',contentWidth/4-5+'%');
                            uiElements.addInput('defaultZoom',{type:'number'},data.defaultZoom || 1,contentWidth/4+5+'%');
                            uiElements.addSelect('defaultZoomPeriod',defaultZoomPeriods,data.defaultZoomPeriod || 3600,contentWidth/2+'%','integer');
                        uiElements.closeGroup();
                        // wheel zoom and pan
                        uiElements.setGroup('wheelPanZoomPlugin',false);
                            uiElements.addLabel('zoom');
                            uiElements.addLabel('factor',contentWidth/4-5+'%');
                            uiElements.addInput('factor',{type:'number',min:0,max:10,step:0.05},data.factor || 0.75,contentWidth/4*3+5+'%'),
                        uiElements.closeGroup();
                        // touch zoom
                        uiElements.setGroup('touchZoomPlugin',false);
                            // no options to set here
                        uiElements.closeGroup();
                        // column-highlights the hovered x index
                        uiElements.setGroup('columnHighlightPlugin',false);
                            uiElements.addLabel('highlightColor');
                            uiElements.addInput('highlight','color',data.highlight || "#33ccff4d",contentWidth+'%');
                        uiElements.closeGroup();
                        // converts the legend into a simple tooltip
                        uiElements.setGroup('legendAsTooltipPlugin',false);
                            uiElements.addLabel('textColor');
                            uiElements.addInput('text','color',data.text || "#000000",contentWidth+'%');
                            uiElements.addElement('br');

                            uiElements.addLabel('backgroundColor');
                            uiElements.addInput('background','color',data.background || "#fffbc4cc",contentWidth+'%');
                        uiElements.closeGroup();
                    uiElements.closeGroup();
                    
                    uiElements.setGroupVisibility(pluginElement,'plugins',data.plugin || 'none');
                }
            });
            $("#node-input-plugins-container").editableList('addItems', this.plugins);

            setTimeout(function() { node.tabs.resize();},0);
        },
        oneditsave: function() {
            var node = this;
            node.uiListElements.series.save(node.series);
            if (node.axes===undefined) node.axes=[];
            node.uiListElements.axes.save(node.axes);
            if (node.scales===undefined) node.scales=[];
            node.uiListElements.scales.save(node.scales);
            if (node.plugins===undefined) node.plugins=[];
            node.uiListElements.plugins.save(node.plugins, false); // save only visible properties
            if (node.dataPlugins===undefined) node.dataPlugins=[];
            node.uiListElements.dataPlugins.save(node.dataPlugins, false);
            
            //node.uiListElements.main.getValue('contextStore',node);
            node.uiListElements.default.getValue('axesX',node);
            node.uiListElements.default.getValue('dataStore',node);
            if (typeof node.dataStore === 'string') {
                node.dataStore={context:'node', store: node.dataStore};
            }
            node.uiListElements.default.getValue('seriesFilter',node);
            // node.uiListElements.main.getValue('defaultColors',node);
        },
        oneditresize: function(size) {
            // uplotResizeList();
        }
    });
</script>

<link rel="stylesheet" href="resources/node-red-contrib-ui-uplot-charts/colr_pickr.min.css" />
<script src="resources/node-red-contrib-ui-uplot-charts/colr_pickr.min.js"></script>
<script src="resources/node-red-contrib-ui-uplot-charts/configUiElements.min.js"></script>

<style type="text/css">
    .colorButton {
        width: 60px !important; 
        height:25px !important; 
        margin: 2px !important;
        padding: 0px !important; 
        box-shadow: none; 
        border-radius: 3px !important; 
        border: solid 1px;
    }
    .alphaPattern {
        width: 60px !important; 
        height:25px !important; 
        margin: 2px 5px 4px 5px !important; 
        padding: 0px;
        border-radius: 3px !important;
        background-image: url("data:image/svg+xml, %3Csvg xmlns='http://www.w3.org/2000/svg' width='100%25' height='100%25'%3E%3Cpattern id='pattern-checkers' x='0' y='0' width='16' height='16' patternUnits='userSpaceOnUse' %3E%3Crect class='checker' x='0' y='0' width='8' height='8' fill='%23eee'/%3E%3Crect class='checker' x='8' y='8' width='8' height='8' fill='%23eee'/%3E%3C/pattern%3E%3Crect id='checkersRect' x='0' y='0' width='100%25' height='100%25' fill='url(%23pattern-checkers)'/%3E%3C/svg%3E");
    }
    .alphaButton { /* to be placed above the alphaPattern */
        position: absolute;
        transform: translate(-67px,2px);
        -ms-transform: translate(-67px, 2px);
    }
    .inputLabels { /* to be placed above inputs */
        pointer-events: none;
        position: relative;
        font-size: 0.7em;
        opacity: 0.8
    }
</style>

<script type="text/html" data-template-name="ui_uplot-charts">

    <div class="form-row">
        <ul style="min-width: 420px; margin-bottom: 20px;" id="node-uplot-config-tabs"></ul>
    </div>

    <div id="node-uplot-config-tabs-content" style="min-height: 170px;">
        <div id="uplot-tab-main-0" style="display:none">
            <div class="form-row" id="template-row-group">
                <label for="node-input-group"><i class="fa fa-table"></i> <span data-i18n='uplot.label.group'></span></label>
                <input type="text" id="node-input-group">
            </div>
        
            <div class="form-row" id="template-row-size">
                <label><i class="fa fa-object-group"></i> <span data-i18n='iro-color.label.size'></span></label>
                <input type="hidden" id="node-input-width">
                <input type="hidden" id="node-input-height">
                <button class="editor-button" id="node-input-size"></button>
            </div>
        
        
            <div id="node-tab-general">
            </div>
        </div>
        <div id="uplot-tab-main-1" style="display:none">
            <div id="node-input-series-top">
            </div>
            <div class="form-row node-input-series-container-row">
                <label for="node-input-series-container" style="vertical-align:top; width:100%;"><i class="fa fa-list-alt"></i> <span data-i18n='uplot.label.series'></span></label>
                <ol id="node-input-series-container"></ol>
            </div>
        </div>
        <div id="uplot-tab-main-2" style="display:none">
            <div id="node-input-axes-top">
            </div>
            <div class="form-row node-input-axes-container-row">
                <label for="node-input-axes-container" style="vertical-align:top; width:100%;"><i class="fa fa-list-alt"></i> <span data-i18n='uplot.label.axes'></span></label>
                <ol id="node-input-axes-container"></ol>
            </div>
        </div>
        <div id="uplot-tab-main-3" style="display:none">
            <div class="form-row node-input-scales-container-row">
                <label for="node-input-scales-container" style="vertical-align:top; width:100%;"><i class="fa fa-list-alt"></i> <span data-i18n='uplot.label.scales'></span></label>
                <ol id="node-input-scales-container"></ol>
            </div>
        </div>
        <div id="uplot-tab-main-4" style="display:none">
            <div class="form-row node-input-plugins-container-row">
                <label for="node-input-plugins-container" style="vertical-align:top; width:100%;"><i class="fa fa-list-alt"></i> <span data-i18n='uplot.label.plugins'></span></label>
                <ol id="node-input-plugins-container"></ol>
            </div>
        </div>
        <div id="uplot-tab-main-5" style="display:none">
            <div id="node-input-data-top">
            </div>
            <div class="form-row node-input-dataPlugins-container-row">
                <label for="node-input-dataPlugins-container" style="vertical-align:top; width:100%;"><i class="fa fa-list-alt"></i> <span data-i18n='uplot.label.dataPlugins'></span></label>
                <ol id="node-input-dataPlugins-container"></ol>
            </div>
        </div>
    </div>

</script>